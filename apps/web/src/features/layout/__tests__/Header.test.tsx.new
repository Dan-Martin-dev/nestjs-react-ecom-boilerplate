import { render, screen, fireEvent } from '@testing-library/react'
import { vi } from 'vitest'
import type { Mock } from 'vitest'
import { Header } from '../components/Header'
import { QueryClient, QueryClientProvider } from '@tanstack/react-query'
import { BrowserRouter } from 'react-router-dom'
import { MantineProvider } from '@mantine/core'
import * as authStoreModule from '../../../stores/auth.store'

// Mock cart hook directly
vi.mock('../../../hooks/useCart', () => ({
  useCart: () => ({ data: { items: [] } }),
  cartKeys: { detail: () => ['cart'] },
}))

// Mock analytics
vi.mock('../../../lib/analytics', () => ({
  trackEvent: vi.fn(),
}))

// Mock the default export (Zustand selector-style store)
vi.mock('../../../stores/auth.store', () => ({
  default: vi.fn(),
}))

// Configure jsdom matchMedia for tests
type WindowWithMatchMedia = Window & {
  matchMedia: (query: string) => MediaQueryList
}

const win = window as unknown as WindowWithMatchMedia
if (typeof win.matchMedia !== 'function') {
  win.matchMedia = (query: string) => ({
    matches: false,
    media: query,
    onchange: null,
    addListener: () => {},
    removeListener: () => {},
    addEventListener: () => {},
    removeEventListener: () => {},
    dispatchEvent: () => false,
  } as unknown as MediaQueryList)
}

describe('Header auth interactions', () => {
  it('shows CERRAR SESION and calls logout when confirmed', async () => {
    const logoutMock = vi.fn().mockResolvedValue(undefined)
    
    // Set up auth store mock
    const mockedStore = (authStoreModule.default as unknown as Mock)
    mockedStore.mockImplementation((selector: (s: any) => unknown) =>
      selector({ isAuthenticated: true, logout: logoutMock })
    )

    // mock window.confirm to always return true
    const confirmSpy = vi.spyOn(window, 'confirm').mockImplementation(() => true)

    // Set up QueryClient
    const qc = new QueryClient({
      defaultOptions: {
        queries: { retry: false, gcTime: 0 }
      }
    })
    
    // Render with all required providers
    render(
      <QueryClientProvider client={qc}>
        <MantineProvider>
          <BrowserRouter>
            <Header />
          </BrowserRouter>
        </MantineProvider>
      </QueryClientProvider>
    )

    // open drawer
    const openBtns = screen.getAllByLabelText(/open menu/i)
    fireEvent.click(openBtns[0])

    // find CERRAR SESION button
    const signOut = await screen.findByText(/CERRAR SESION/i)
    fireEvent.click(signOut)

    expect(confirmSpy).toHaveBeenCalled()
    expect(logoutMock).toHaveBeenCalled()

    confirmSpy.mockRestore()
  })
})
